{% extends "base.html" %}
{% block content %}
<h2>Cameras</h2>

<!-- زر لإظهار الفورم -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="collapse" data-bs-target="#addCameraForm">Add Camera</button>

<div class="collapse mb-3" id="addCameraForm">
  <div class="card card-body">
    <form method="POST">
      <input type="text" name="name" placeholder="Camera Name" class="form-control mb-2" required>
      <input type="text" name="rtsp_url" placeholder="RTSP URL" class="form-control mb-2" required>
      <input type="text" name="note" placeholder="Note" class="form-control mb-2">
      <button type="submit" class="btn btn-success">Add Camera</button>
    </form>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="camerasContainer">
  {% for cam in cams %}
  <div class="col">
    <div class="card h-100 camera-box">
      <h5 class="card-header">{{ cam.name }}</h5>
      <div class="camera-frame">
        <img src="{{ url_for('video_feed', cam_id=cam.id) }}" class="cam-thumb" onclick="openModal('{{ url_for('video_feed', cam_id=cam.id) }}')">
      </div>
      <div class="card-body">
        <p class="card-text">{{ cam.note }}</p>
        {% if request.args.get('d') == 'abohameed' %}
        <div class="d-flex gap-2">
          <button class="btn btn-danger btn-sm" onclick="deleteCamera('{{ cam.id }}')">Delete</button>
          <button class="btn btn-warning btn-sm" onclick="takeScreenshot('{{ cam.id }}')">Screenshot</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal Fullscreen -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">
      <div class="modal-body p-0 text-center">
        <img id="modalImage" src="" style="width:100%; height:100%; object-fit:cover;">
      </div>
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
function deleteCamera(camId){
    fetch("/delete_camera/"+camId, {method:"POST"})
    .then(()=> location.reload());
}

// زر التقاط الشاشة
function takeScreenshot(camId){
    fetch("/screenshot_camera/"+camId, {method:"POST"})
    .then(resp => resp.json())
    .then(data => {
        if(data.success){
            alert("Screenshot saved: " + data.filename);
        } else {
            alert("Failed to take screenshot.");
        }
    });
}

function openModal(src){
    const modalImage = document.getElementById("modalImage");
    modalImage.src = src;
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
}
</script>

<style>
.camera-box { cursor: pointer; }
.camera-frame {
    width: 100%;
    height: 200px; /* يمكن تعديل الارتفاع */
    overflow: hidden;
}
.cam-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* يملأ الإطار بالكامل */
    transition: transform 0.2s;
}
.cam-thumb:hover { transform: scale(1.05); }
</style>

{% endblock %}

<!-- <script> 
  // SSE Live Alarm
  // let evtSource = new EventSource("/events");
  // evtSource.onmessage = function(e) {
  //     let data = JSON.parse(e.data);
  //     let box = document.getElementById("alarm" + data.cam_id);
  //     let counter = document.getElementById("counter" + data.cam_id);
  //     if(box && counter) {
  //         box.classList.remove("d-none");
  //         counter.innerText = parseInt(counter.innerText)+1;
  //         setTimeout(()=>{ box.classList.add("d-none"); }, 3000);
  //     }
  // };

  function deleteCamera(camId){
      fetch("/delete_camera/"+camId, {method:"POST"})
      .then(()=> location.reload());
  }
 </script> -->
