{% extends "base.html" %}
{% block content %}
<h2>Users List</h2>
<a href="{{ url_for('add_user') }}" class="btn btn-success mb-2">Add User</a>

<!-- Search box -->
<input type="text" id="userSearch" class="form-control mb-3" placeholder="Search by name...">

<div id="usersList">
    {% for u in users %}
        <div class="card user-card mb-2">
            <div class="card-body">
                <h5 class="card-title">{{ u.userName }}</h5>
                <p class="card-text">
                    <strong>Email:</strong> {{ u.userEmailAddress }}<br>
                    <strong>Expiration:</strong> {{ u.dateExpiration }}
                </p>
                <a href="{{ url_for('encode', user_id=u.userId) }}" class="btn btn-primary btn-sm">Send Key</a>
                <!-- زر Matrix -->
                <button class="btn btn-warning btn-sm" onclick="openMatrix({{ u.userId }}, '{{ u.userName }}')">Matrix</button>
                <a href="{{ url_for('delete_user', user_id=u.userId) }}" class="btn btn-danger btn-sm">Delete</a>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Modal -->
<div class="modal fade" id="matrixModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Doors</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="matrixBody">
        <!-- Dynamic content -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id="saveMatrixBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('userSearch').addEventListener('input', function() {
    let filter = this.value.toLowerCase();
    let cards = document.querySelectorAll('.user-card');
    cards.forEach(function(card) {
        let name = card.querySelector('.card-title').textContent.toLowerCase();
        card.style.display = name.includes(filter) ? '' : 'none';
    });
});

// فتح المودال وعرض الأبواب
function openMatrix(userId, userName) {
    fetch('/smartair/doors/list')
        .then(res => res.json())
        .then(data => {
            let doors = data.doors;
            let html = `<h5>Assign Doors for ${userName}</h5><form id="doorsForm">`;
            doors.forEach(d => {
                html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${d.doorId}" id="door${d.doorId}">
                    <label class="form-check-label" for="door${d.doorId}">${d.doorName} (ID: ${d.doorId})</label>
                </div>`;
            });
            html += `</form>`;
            document.getElementById('matrixBody').innerHTML = html;
            var matrixModal = new bootstrap.Modal(document.getElementById('matrixModal'));
            matrixModal.show();

            document.getElementById('saveMatrixBtn').onclick = function(){
                let checkedDoors = Array.from(document.querySelectorAll('#doorsForm input[type=checkbox]:checked')).map(c => c.value);
                fetch(`/smartair/assign_doors/${userId}`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({doors: checkedDoors})
                }).then(res=>{
                    if(res.ok) {
                        alert('Doors assigned successfully');
                        matrixModal.hide();
                    }
                });
            }
        });
}
</script>
{% endblock %}
