<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ecobee Thermostats</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.card { margin: 5px; font-size: 0.9rem; transition: transform 0.2s; }
.card:hover { transform: translateY(-3px); }
.card-header { font-weight: bold; font-size: 1rem; padding: 0.3rem 0.5rem; }
.card-body { padding: 0.5rem; }
.form-control, select, button { font-size: 0.8rem; margin-top: 2px; }
</style>
</head>
<body>
    <a href="../" class="btn btn-secondary btn-sm position-fixed" style="top: 10px; right: 10px;">← Back</a>
<div class="container">
<h2 class="text-center mb-3">Ecobee Thermostats</h2>
<div id="device-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2">
    {% for device in devices %}
    <div class="col device-card" data-entity="{{ device.entity_id }}">
        <div class="card shadow-sm">
            <div class="card-header text-center">{{ device.attributes.friendly_name }}</div>
            <div class="card-body text-center">
                <p class="mb-1"><strong>State:</strong> {{ device.state|capitalize }}</p>
                {% if device.attributes.current_temperature %}
                <p class="mb-1"><strong>Current:</strong> {{ device.attributes.current_temperature }}°C</p>
                {% endif %}
                {% if device.attributes.temperature %}
                <form action="{{ url_for('set_temperature', entity_id=device.entity_id) }}" method="post">
                    <input type="number" class="form-control temp-input" name="temperature"
                           step="0.5" min="{{ device.attributes.min_temp }}"
                           max="{{ device.attributes.max_temp }}"
                           value="{{ device.attributes.temperature }}">
                    <button type="submit" class="btn btn-primary w-100 mt-1">Set Temp</button>
                    
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
</div>

<script>
async function fetchDevices() {
    try {
        const res = await fetch('/update_devices');
        const devices = await res.json();
        const container = document.getElementById('device-container');
        container.innerHTML = ''; // مسح القديم

        devices.forEach(device => {
            const col = document.createElement('div');
            col.className = 'col device-card';
            col.dataset.entity = device.entity_id;

            col.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-header text-center">${device.attributes.friendly_name}</div>
                <div class="card-body text-center">
                    <p class="mb-1"><strong>State:</strong> ${device.state.charAt(0).toUpperCase() + device.state.slice(1)}</p>
                    ${device.attributes.current_temperature ? `<p class="mb-1"><strong>Current:</strong> ${device.attributes.current_temperature}°C</p>` : ''}
                    ${device.attributes.temperature ? `
                    <form action="/set_temperature/${device.entity_id}" method="post">
                        <input type="number" class="form-control temp-input" name="temperature"
                            step="0.5" min="${device.attributes.min_temp}" max="${device.attributes.max_temp}"
                            value="${device.attributes.temperature}">
                        <button type="submit" class="btn btn-primary w-100 mt-1">Set Temp</button>
                    </form>` : ''}
                </div>
            </div>`;
            container.appendChild(col);
        });
    } catch (err) {
        console.error(err);
    }
}

// تحديث كل 5 ثواني
setInterval(fetchDevices, 5000);
</script>
</body>
</html>
